<html>
  <head>
    <!-- https://getbootstrap.com/docs/4.0/getting-started/introduction/ -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script>
    <script src="math.js"></script>
    <script src="svg.js"></script>
  </head>
  <body>
    <div class='container'>
      <div class='row'>
      <fieldset>
        <legend>Axial Flux Generator Designer (mm)</legend>
        <form onchange="draw()">
          <div class="card-columns">
            <!-- type="text" pattern="[0-9]+" maxlength="3" minlength="1" -->
            <!-- type="number" min="1" max="9999" -->
            <div class='card  text-nowrap'>
              <div class=''>
                  <label for="num_magnets">Number of Magnets</label>
                  <input type="number" id="num_magnets" name="num_magnets" placeholder="# magnets"
                        min="4" max="9999" step='1' value="12" required />
              </div>
              <div class=''>
                <label for="mag_shape">Shape of Magnet</label>
                <input type = "radio"
                      name = "mag_shape"
                      id = "shapeRect"
                      value = "rect"
                      checked = "checked" />
                <label for = "shapeRect">rect</label>
                <input type = "radio"
                      name = "mag_shape"
                      id = "shapeCircle"
                      value = "circle" />
                <label for = "shapeCircle">circle</label>
              </div>
              <div id='dia_magnet_group' class=''>
                  <label for="dia_magnet">Dia of Magnet</label>
                  <input type="number" id="dia_magnet" name="dia_magnet" placeholder="Magnet Dia"
                        min="1" max="9999" value="20" required />
              </div>
              <div id='w_magnet_group' class=''>
                  <label for="w_magnet">Magnet Width</label>
                  <input type="number" id="w_magnet" name="w_magnet" placeholder="Magnet Width"
                        min="1" max="9999" value="20" required />
              </div>
              <div id='h_magnet_group' class=''>
                  <label for="h_magnet">Magnet Height</label>
                  <input type="number" id="h_magnet" name="h_magnet" placeholder="Magnet Height"
                        min="1" max="9999" value="15" required />
              </div>
              <div class=''>
                  <label for="mag_mid_dia">Magnet Placement Diameter</label>
                  <input type="number" id="mag_mid_dia" name="mag_mid_dia" placeholder="Mag Mid Dia"
                        min="1" max="9999" value="90" required />
              </div>
            </div>
            <div class='card  text-nowrap'>
              <div class=''>
                  <label for="outside_dia">Outside Diameter</label>
                  <input type="number" id="outside_dia" name="outside_dia" placeholder="Outside Dia"
                        min="1" max="9999" value="130" required />
              </div>
              <div class=''>
                  <label for="in_dia">Coil Disc Inside Diameter</label>
                  <input type="number" id="in_dia" name="in_dia" placeholder="Inside Dia"
                        min="1" max="9999" value="30" required />
              </div>
              <div class=''>
                  <label for="in_dia2">Magnet Disc Inside Diameter</label>
                  <input type="number" id="in_dia2" name="in_dia2" placeholder="Inside Dia"
                        min="1" max="9999" value="25" required />
              </div>
            </div>
            <div class='card  text-nowrap'>
              <div class=''>
                <label for="coil_type">Type of Coil</label>
                <input type = "radio"
                      name = "coil_type"
                      id = "coilSerpentine"
                      value = "serpintine"
                      checked = "checked" />
                <label for = "coilSerpentine">serpentine</label>
                <input type = "radio"
                      name = "coil_type"
                      id = "coilLoops"
                      value = "loops"  />
                <label for = "coilLoops">loops</label>
              </div>
              <div id='num_serpents_group' class=''>
                  <label for="num_serpents">Number of Coils</label>
                  <input type="number" id="num_serpents" name="num_serpents" placeholder="# serpents"
                        min="4" max="9999" step='1' value="1" required />
              </div>
              <div class=''>
                  <label for="mag_out_dia">Coil Outside Diameter</label>
                  <input type="number" id="mag_out_dia" name="mag_out_dia" placeholder="Coil Outside Dia"
                        min="1" max="9999" value="128" required />
              </div>
              <div class=''>
                  <label for="mag_in_dia">Coil Inside Diameter</label>
                  <input type="number" id="mag_in_dia" name="mag_in_dia" placeholder="Coil Inside Diameter"
                        min="1" max="9999" value="58" required />
              </div>
              <div class=''>
                  <label for="coil_thickness">Coil Thickness (dia)</label>
                  <input type="number" id="coil_thickness" name="coil_thickness" placeholder="Coil Thickness"
                        min="1" max="9999" value="4" required />
              </div>
            </div>
          </div>
        </form>
      </fieldset>
    </div>
    <div class='row'>
      <div id='errors' style="color:red"></div>
    </div>
    <div class='row'>
      <div class='col-sm bg-primary p-0 m-0'>
        <div style='background-color: #333333;'>
          <svg id="svg" viewBox="-100 -100 100 100">
            <!--<rect width="100%" height="100%" fill="grey"/>-->
          </svg>
        </div>
      </div>
      <div class='col-sm'>
        <a id='download' class='btn btn-primary pointer btn-lg active' href="">Download .svg</a>
        <div>Legend:</div>
        <ul>
        <div style="color:#ff00aa">wire winder tool</div>
        <div style="color:#ff9900">wire</div>
        <div style="color:#99bbff">magnets</div>
        <div style="color:#aaaaaa">rotor/stator disc(s), resin mold</div>
        </ul>
        <button type="button" class="btn btn-dark" onclick="onAnimate()">Animate</button>
      </div>
    </div>
    </div>
    <style>
      @media (min-width: 576px) {
        .card-columns { column-count: 2; }
      }
      @media (min-width: 768px) {
        .card-columns { column-count: 2; }
      }
      @media (min-width: 992px) {
        .card-columns { column-count: 3; }
      }
      @media (min-width: 1200px) {
        .card-columns { column-count: 3; }
      }
      .rot {
        animation: rot 30.0s linear infinite;
      }
      @keyframes rot {
        0% {
          -webkit-transform:  rotate(180deg) rotate(0deg);
          -moz-transform:  rotate(180deg) rotate(0deg);
          transform: rotate(180deg) rotate(0deg);
        }
        100% {
          -webkit-transform:  rotate(180deg) rotate(360deg);
          -moz-transform:  rotate(180deg) rotate(360deg);
          transform: rotate(180deg) rotate(360deg);
        }
      }
    </style>
    <script>
      let c0 = "#aaaaaa";
      let c1 = "#99bbff";
      let c1b = "#99bb00";
      let c2 = "#ff9900";
      let c3 = "#ff00aa";

      // as much as we can, unwind the serpentine so we have a big (almost round) polygon,
      // so it will tend to crimp the wire in the right places to guide in bending the serpentine shape
      function makeSerpentWinder( path, rot, pos, num_magnets, mag_in_dia, mag_out_dia, coilWinderRadius ) {
         let path2 = [];
         let arc_len_deg = 360/(num_magnets*0.5);
         let arc_len_rad = arc_len_deg * Math.PI/180;
         for (let x = 0; x < (num_magnets/2 - 0.5); ++x) {
            // generate some arc stats for this iteration
            let s = x * arc_len_rad;
            let s1d = arc_len_rad*0.5;
            let s1 = s+s1d;
            let s2d = arc_len_rad;
            let s2 = s+s2d;
            let outer_start     = radialToCartesian( pos.x,pos.y, mag_out_dia/2, s );
            let outer_end       = radialToCartesian( pos.x,pos.y, mag_out_dia/2, s1 );
            let inner_start     = radialToCartesian( pos.x,pos.y, mag_in_dia/2, s1 );
            let inner_end       = radialToCartesian( pos.x,pos.y, mag_in_dia/2, s2 );
            // we're going to project (move w/ no scale) 2 segments to the coilWinderRadius circle
            // the outer and the inner segments.  The segments inbetween will magically appear correct. :)
            // * get each segment's length
            let i1 = dist( outer_start, outer_end );
            let i3 = dist( inner_start, inner_end );
            // * coilWinderRadius circle is always larger than mag_out_dia
            //   if we pushed the segment out to the larger coilWinderRadius circle (same length)
            //   calc the (now narrower) sweep angle that sweeps the segment length
            let i1r_half = Math.asin(i1*0.5/coilWinderRadius); // sin(t) = o/a
            let i3r_half = Math.asin(i3*0.5/coilWinderRadius);
            // * calc the angle that passes through each segment's center point
            let s_s1 = s + s1d/2;
            let s1_s2 = s1 + s1d/2;
            // * calc the points for 3 segments, add to the path (4th segment we get for free next iteration)
            let p0 = radialToCartesian( pos.x,pos.y, coilWinderRadius, s_s1 - i1r_half );
            let p1 = radialToCartesian( pos.x,pos.y, coilWinderRadius, s_s1 + i1r_half );
            let p2 = radialToCartesian( pos.x,pos.y, coilWinderRadius, s1_s2 - i3r_half );
            let p3 = radialToCartesian( pos.x,pos.y, coilWinderRadius, s1_s2 + i3r_half );
            path2.push( p0 );
            path2.push( p1 );
            path2.push( p2 );
            path2.push( p3 );
         }
         path.push( path2 );
      }

      // make a serpent shaped wire coil
      // coilt is the offset used for coilthickness (call makeSerpent multiple times)
      // return path (that is appended with the new serpent)
      // return coilWinderCircumference
      function makeSerpent( path, rot, pos, num_magnets, mag_in_dia, mag_out_dia, coilt ) {
         let path2 = []
         let coilWinderCircumference = 0;
         let arc_len_deg = 360/(num_magnets*0.5);
         let arc_len_rad = arc_len_deg * Math.PI/180;
         clearPath( svgdebug );
         // generate some arc stats for this iteration
         for (let x = 0; x < (num_magnets/2); ++x) {
            let s = rot + x * arc_len_rad;
            let s1d = arc_len_rad*0.5;
            let s1 = s+s1d;
            let s2d = arc_len_rad;
            let s2 = s+s2d;
            let sneg = s-s1d;
            let inner_start_prev= radialToCartesian( pos.x,pos.y, mag_in_dia/2, sneg );
            let inner_end_prev  = radialToCartesian( pos.x,pos.y, mag_in_dia/2, s );
            let outer_start     = radialToCartesian( pos.x,pos.y, mag_out_dia/2, s );
            let outer_end       = radialToCartesian( pos.x,pos.y, mag_out_dia/2, s1 );
            let inner_start     = radialToCartesian( pos.x,pos.y, mag_in_dia/2, s1 );
            let inner_end       = radialToCartesian( pos.x,pos.y, mag_in_dia/2, s2 );
            let rt = mul( perp( dir( inner_end_prev, outer_start ) ), vec( coilt ) );
            let lt = mul( perp( dir( outer_end, inner_start ) ), vec( coilt ) );
            let dnp = mul( perp( dir( inner_start_prev, inner_end_prev ) ), vec( coilt ) );
            let dn = mul( perp( dir( outer_start, outer_end ) ), vec( coilt ) );
            let dnn = mul( perp( dir( inner_start, inner_end ) ), vec( coilt ) );
            let ox=0, oy=0; // in case you need an offset... here it is, move it up to the inputs.
            let p0 = add( line_intersect( add( inner_start_prev, dnp ), add( inner_end_prev, dnp ),
                                          add( inner_end_prev, rt ), add( outer_start, rt ) ), vec(ox,oy) );
            let p1 = add( line_intersect( add( inner_end_prev, rt ), add( outer_start, rt ),
                                          add( outer_start, dn ), add( outer_end, dn ) ), vec(ox,oy) );
            let p2 = add( line_intersect( add( outer_start, dn ), add( outer_end, dn ),
                                          add( outer_end, lt ), add( inner_start, lt ) ), vec(ox,oy) );
            let p3 = add( line_intersect( add( outer_end, lt ), add( inner_start, lt ),
                                          add( inner_start, dnn ), add( inner_end, dnn ) ), vec(ox,oy) );
            path2.push( p0 );
            path2.push( p1 );
            path2.push( p2 );
            path2.push( p3 );
            coilWinderCircumference += dist( inner_end_prev, outer_start );
            coilWinderCircumference += dist( outer_start, outer_end );
            coilWinderCircumference += dist( outer_end, inner_start );
            coilWinderCircumference += dist( inner_start, inner_end );
         }
         path.push( path2 );

         // approx radius for the coil winder
         let coilWinderRadius = coilWinderCircumference / (2*Math.PI);
         return coilWinderRadius;
      }

      // create one single-coil loop
      function makeLoop( path, ox, oy, x, pos, num_magnets, mag_in_dia, mag_out_dia, coilt ) {
         let path2 = [];
         // generate some arc stats for this iteration
         let arc_len_deg = 360/num_magnets;
         let arc_len_rad = arc_len_deg * Math.PI/180;
         let s = x * arc_len_rad;
         let s1d = arc_len_rad;
         let s1 = s+s1d;
         // 1 2
         // 0 3
         let inner_end_prev  = radialToCartesian( pos.x,pos.y, mag_in_dia/2, s );
         let outer_start     = radialToCartesian( pos.x,pos.y, mag_out_dia/2, s );
         let outer_end       = radialToCartesian( pos.x,pos.y, mag_out_dia/2, s1 );
         let inner_start     = radialToCartesian( pos.x,pos.y, mag_in_dia/2, s1 );
         let up1 = mul( dir( outer_start, inner_end_prev ), vec( coilt ) );
         let up2 = mul( dir( outer_end, inner_start ), vec( coilt ) );
         let dn1 = inv( up1 );
         let dn2 = inv( up2 );
         let lt = mul( dir( outer_start, outer_end ), vec( coilt ) );
         let rt = mul( dir( outer_end, outer_start ), vec( coilt ) );

         let p0 = add( add( add( inner_end_prev, up1 ), rt ), vec(ox,oy) );
         let p1 = add( add( add( outer_start, dn1 ),    rt ), vec(ox,oy) );
         let p2 = add( add( add( outer_end, dn2 ),      lt ), vec(ox,oy) );
         let p3 = add( add( add( inner_start, up2 ),    lt ), vec(ox,oy) );
         path2.push(p0);
         path2.push(p1);
         path2.push(p2);
         path2.push(p3);
         path2.push(p0);
         path.push( path2 );
      }

      // create all the single-coil loops in a ring
      function makeLoops( path, pos, num_magnets, mag_in_dia, mag_out_dia, coilt ) {
         for (let x = 0; x < num_magnets; ++x) {
            makeLoop( path, 0,0, x, pos, num_magnets, mag_in_dia, mag_out_dia, coilt );
         }
      }

      // draw the diagram into the <svg>
      function draw() {
        errors.innerHTML = '';

        // update controls
        dia_magnet_group.hidden = !shapeCircle.checked;
        w_magnet_group.hidden = shapeCircle.checked;
        h_magnet_group.hidden = shapeCircle.checked;
        num_serpents_group.hidden = !coilSerpentine.checked;

        // construct the svg
        clearSvg( svg );
        let svgdebug = newPath( svg, "svgdebug" );
        let svgdiscpath = newPath( svg, "svgdiscpath" );

        let vwidth = 0, vheight = 0;
        let pos = { x: 0, y: 0 };

        // disc geometry
        setPath(c0, svgdiscpath,
            [circlePath( pos.x,pos.y, outside_dia.value/2 ),
            circlePath( pos.x,pos.y, in_dia.value/2 ),
            circlePath( pos.x,pos.y, in_dia2.value/2 )].join(' ')
        );

        // wire geometry
        if (coilSerpentine.checked && +num_magnets.value % 2 == 1) errors.innerHTML = "ERROR: for serpentine coils, please give an even number of magnets";
        if (coilLoops.checked && +num_magnets.value % 2 == 1) errors.innerHTML = "ERROR: for loop coils, please give an even number of magnets";
        {
          let coilWinderCircumference = 0;
          let winder_path = [];

          // one big loop of wire (minimize waste, easier to wind, etc.)
          if (coilSerpentine.checked) {
            let coilWinderRadius;
            for (let snake = 0; snake < +num_serpents.value; ++snake) {
              let path = [];
              let svgcoilpath = newPath( svg, `svgcoilpath${snake}` );
              let rotoffset = (1/+num_magnets.value) * (snake/(+num_serpents.value)) * 2 * Math.PI;
              let result = makeSerpent( path, rotoffset, pos, +num_magnets.value, +mag_in_dia.value, +mag_out_dia.value, 0 );
              if (coilWinderRadius == undefined)
                coilWinderRadius = result;
              makeSerpent( path, rotoffset, pos, +num_magnets.value, +mag_in_dia.value, +mag_out_dia.value, (+coil_thickness.value)/2 );
              makeSerpent( path, rotoffset, pos, +num_magnets.value, +mag_in_dia.value, +mag_out_dia.value, -(+coil_thickness.value)/2 );
              setPath( c2, svgcoilpath, vecArraysToSvgPathData( path ) );
            }

            let winder_path = [];
            makeSerpentWinder( winder_path, 0, pos, +num_magnets.value, +mag_in_dia.value, +mag_out_dia.value, coilWinderRadius );
            let svgwrappath = newPath( svg, `svgwrappath` );
            setPath( c3, svgwrappath, vecArraysToSvgPathData( winder_path ) );

            // lazy approach, just make the winder a pure circle
            // (inaccurate because the serpentine is chunky-polygonal, not smooth-curved,
            //  so your wire loop'll be _slightly_ too long this way)
            //setPath( c3, svgwrappath, circlePath( pos.x, pos.y, coilWinderRadius ) );

            // setup the svg's viewbox so it zooms in nice
            vwidth = vheight = Math.max( coilWinderRadius * 2, outside_dia.value );
          } else {
            let path = [];
            makeLoops( path, pos, +num_magnets.value, +mag_in_dia.value, +mag_out_dia.value, 0 );
            makeLoops( path, pos, +num_magnets.value, +mag_in_dia.value, +mag_out_dia.value, +coil_thickness.value );
            let svgcoilpath = newPath( svg, `svgcoilpath` );
            setPath( c2, svgcoilpath, vecArraysToSvgPathData( path ) );

            let winder_path = [];
            makeLoop( winder_path, -4,4, 0, pos, +num_magnets.value, +mag_in_dia.value, +mag_out_dia.value, 0 );
            makeLoop( winder_path, -4,4, 0, pos, +num_magnets.value, +mag_in_dia.value, +mag_out_dia.value, +coil_thickness.value );
            let svgwrappath = newPath( svg, `svgwrappath` );
            setPath( c3, svgwrappath, vecArraysToSvgPathData( winder_path ) );

            // setup the svg's viewbox so it zooms in nice
            vwidth = vheight = +outside_dia.value;
          }
        }

        // magnet geometry
        {
          let svgmagpath = newPath( svg, `svgmagpath` );
          let svgmagpath2 = newPath( svg, `svgmagpath2` );
          let path1 = [];
          let path2 = [];
          for (let x = 0; x < +num_magnets.value; ++x) {
            let path;
            let arc_len_deg = 360/(num_magnets.value*0.5);
            let arc_len_rad = arc_len_deg * Math.PI/180;
            let s = x * arc_len_rad*0.5;
            let mag_centerN = radialToCartesian( pos.x,pos.y, mag_mid_dia.value/2, s );
            if (shapeCircle.checked) {
              path = circlePath( mag_centerN.x, mag_centerN.y, dia_magnet.value*0.5 );
            } else {
              path = rectPath( mag_centerN.x, mag_centerN.y, w_magnet.value, h_magnet.value, s );
            }
            if (x % 2 === 1)
              path1.push( path );
            else
              path2.push( path );
          }
          setPath( c1, svgmagpath, path1.join(' ') );
          setPath( c1b, svgmagpath2, path2.join(' ') );
        }
        svg.setAttribute( 'viewBox', `${- +vwidth/2 - 2} ${- +vheight/2 - 2} ${+vwidth + 4} ${+vheight + 4}` );
        createSVGDownload( svg, download );
      }
      function init() {
        draw();
      }
      window.onload = init();
      //init();
    </script>

  </body>
</html>

